<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>ECE 5160 Lab 4</title>
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
        <!-- Font Awesome icons (free version)-->
        <script src="https://use.fontawesome.com/releases/v6.1.0/js/all.js" crossorigin="anonymous"></script>
        <!-- Google fonts-->
        <link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css" />
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="css/styles.css" rel="stylesheet" />
    </head>
    <body>
        <!-- Navigation-->
        <nav class="navbar navbar-expand-lg navbar-light" id="mainNav">
            <div class="container px-4 px-lg-5">
                <a class="navbar-brand" href="index.html">ECE 5160 Home</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                    Menu
                    <i class="fas fa-bars"></i>
                </button>
                <div class="collapse navbar-collapse" id="navbarResponsive">
                    <ul class="navbar-nav ms-auto py-4 py-lg-0">
                        <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="index.html">Home</a></li>
                        <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="about.html">About</a></li>
                    </ul>
                </div>
            </div>
        </nav>
        <!-- Page Header-->
        <header class="masthead" style="background-image: url('assets/img/gradient_background.jpeg')">
            <div class="container position-relative px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5 justify-content-center">
                    <div class="col-md-10 col-lg-8 col-xl-7">
                        <div class="post-heading">
                            <h1>Lab 4: IMU</h1>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <!-- Post Content-->
        <article class="mb-4">
            <div class="container px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5 justify-content-center">
                    <div class="col-md-10 col-lg-8 col-xl-7">
                        <h2 class="section-heading">Objective</h2>
                        <p>In lab 4, I learned how to get pitch, roll, and yaw from the IMU (Inertial Measurement Unit) sensors and transmitted the data over bluetooth from the Artemis. I also used batteries to power the Artemis so it could collect data while the car was running. This will eventually be used to collect orientation data for the robot later. </p>
                        
                        <h2 class="section-heading">Set Up the IMU</h2>
                        <img src="assets/img/lab4_setup.png" style="object-fit:contain; width:75%">
                        <p>I started off by running the IMU example code to ensure that the sensor worked. The following video demonstrates the sensor behavior as I rotate, flip, and accelerate the board.</p>
                        <iframe width="560" height="315" src="https://www.youtube.com/embed/IjjQEbhLoDY" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                        <p>In the beginning, I simply rotate the sensor slowly, causing changes in the gyroscope data. Keeping the orientation the same and moving the sensor back and forth along various planes would cause the accelerometer to oscillate, as seen in the video. Most of the values started at 0, but accelerometer data for Z was larger than 0 due to the force of gravity. </p>
                        <p>In the code, the AD0_VAL is set to 1 as the default. This value sets the I2C address as binary 1101001, or hexadecimal 0x69. To use a second IMU, one would simply just need to modify the code for the second IMU to change the I2C address to a  different one.</p>

                        <h2 class="section-heading">Accelerometer</h2>
                        <p>The accelerometer data could be used to calculate pitch and roll. The following equations were used: </p>
                        <p>Pitch: </p>
                        <img src="https://latex.codecogs.com/svg.image?\theta&space;=&space;atan2(x_{accel},&space;y_{accel}&space;)" title="https://latex.codecogs.com/svg.image?\theta = atan2(x_{accel}, y_{accel} )" />
                        <p>Roll: </p>
                        <img src="https://latex.codecogs.com/svg.image?\phi&space;=&space;atan2(y_{accel},&space;z_{accel}&space;)" title="https://latex.codecogs.com/svg.image?\phi = atan2(y_{accel}, z_{accel} )" />
                        <p>There is no way to get yaw from accelerometer data, so that was not calculated in this part. </p>
                        <p>The following image demonstrates the pitch calculated from the first equation as I rotated the IMU from -90, 0, to 90 degrees around the x-axis.  </p>
                        <img src="assets/img/lab4_pitchaccel.png" style="object-fit:contain; width:100%">
                        <p>The following image demonstrates the roll calculated from the first equation as I rotated the IMU from -90, 0, to 90 degrees around the y-axis.  </p>
                        <img src="assets/img/lab4_rollaccel.png" style="object-fit:contain; width:100%">
                        <p>As one can see from the data that was acquired, the pitch and roll being calculated were fairly accurate for these angles, so no calibration was necessary. </p>

                        <p><b>Accelerometer Noise</b></p>
                        <p>To determine how noise affected the IMU, I ran the car above the IMU as it collected accelerometer data. I did this for both pitch and roll calculations and ran an FFT using the example code from Arduino's FFT library. </p>
                        <img src="assets/img/lab4_pitchaccel_fft.png" style="object-fit:contain; width:100%">
                        <img src="assets/img/lab4_rollaccel_fft.png" style="object-fit:contain; width:100%">
                        <p>While the sensor was fairly good at filtering out this noise, I decided that the amplitude of the higher frequencies was large enough (amplitude was at least 12.5% of the actual signal noise) that I needed a low pass filter. This was a simple weighted average as seen from the lecture below: </p>
                        <img src="assets/img/lab4_lpfeq.png" style="object-fit:contain; width:100%">
                        <p>where the RC was taken from the cutoff frequency equation. In this case, the cutoff frequency was 20 Hz, meaning the alpha used in the filter was approximately 0.136. </p>
                        <p>Here are the code snippets that were used to calculate the pitch with the low pass filter incorporated. </p>
                        <script src="https://gist.github.com/umdiddle/d948ba3ab9140c5b70b127c64c703b1b.js"></script>

                        <h2 class="section-heading">Gyroscope</h2>
                        <p>The gyroscope data could also be used to calculate pitch and roll, as well as yaw. The following equations were used: </p>
                        <p>Pitch: </p>
                        <img src="https://latex.codecogs.com/svg.image?\theta_{n}&space;=&space;\theta_{n-1}&space;-&space;x_{gyro}&space;*&space;dt" title="https://latex.codecogs.com/svg.image?\theta_{n} = \theta_{n-1} - x_{gyro} * dt" />
                        <p>Roll: </p>
                        <img src="https://latex.codecogs.com/svg.image?\phi_{n}&space;=&space;\phi_{n-1}&space;&plus;&space;z_{gyro}&space;*&space;dt" title="https://latex.codecogs.com/svg.image?\phi_{n} = \phi_{n-1} + z_{gyro} * dt" />
                        <p>Yaw: </p>
                        <img src="https://latex.codecogs.com/svg.image?\psi_{n}&space;=&space;\psi_{n-1}&space;-&space;y_{gyro}&space;*&space;dt" title="https://latex.codecogs.com/svg.image?\psi_{n} = \psi_{n-1} - y_{gyro} * dt" />
                        <p>The following code was responsible to calculate all three of these measurements. </p>
                        <script src="https://gist.github.com/umdiddle/576f285463a72282e05a4d44dc1fa618.js"></script>
                        <iframe width="560" height="315" src="https://www.youtube.com/embed/3Gt7VClLfiM" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                        
                        <p><b>Complementary Filter</b></p>
                        <p>The gyroscope roll data had a bit of drift associated with it. This was dependent on the dt, as shown below. </p>
                        <p>Drift from sampling at 100Hz: </p>
                        <img src="assets/img/lab4_rolldrift_100Hz.png" style="object-fit:contain; width:100%">
                        <p>Drift from sampling at 200Hz: </p>
                        <img src="assets/img/lab4_rolldrift_200Hz.png" style="object-fit:contain; width:100%">
                        <p>As one can see, the drift was nearly halved at the higher sampling frequency. Thus, I chose to use 200Hz as my sampling rate for this. Additionally, because we had pitch and roll data from both the accelerometer and gyroscope data, I used a complementary filter to incorporate data from both. The code for this is seen below: </p>
                        <script src="https://gist.github.com/umdiddle/5ff60581018a4b1ccb9c1724e92b2937.js"></script>
                        <p>Note that the alpha that was chosen for this section was 0.9, as I wanted to prioritize accuracy over noise of the sensor. Due to this, there was no drift and the data was still relatively clean. </p>
                        <p>This following video demonstrates the complementary filter and shows that the drift from the gyroscope has largely disappeared. </p>
                        <iframe width="560" height="315" src="https://www.youtube.com/embed/cNbOflLPqKo" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

                        <h2>Sample Data</h2>
                        <p>After removing delays and Serial.print statements, I was able to sample new values at a speed of TODO</p>
                        <p>I then combined the code from before with the ble_arduino code to send timestamped pitch, roll, and yaw data, along with ToF data, back to the laptop over bluetooth. The code is seen below, along with the data: </p>
                        <script src="https://gist.github.com/umdiddle/bfe71fa24789cd18413c1f1eecfbca8c.js"></script>
                        <img src="assets/img/lab4_pitchrollyaw.png" style="object-fit:contain; width:100%">
                        <p>To do this, I stored the values in separate arrays locally on the Artemis before sending the data over bluetooth as one message labeled by data type ("T:" for time, "P:" for pitch, etc) separated by the "|" character. This is to more efficiently be able to collect data, as each of the sensors will have data available at different times. Thus, the arrays were split into tof1, tof2, and imu data. </p>
                        
                        <h2 class="section-heading">Cut the Coord</h2>
                        <p>At this point, the Artemis was powered off of the battery. I had two batteries from lab, a 3.7V 850mAh battery and a 3.7V 650mAh battery. We used the 650mAh battery to power the artemis, and the 850mAh battery to drive the motors. This is because the motors require more power, and the power and ground need to be separated to avoid noise from the motors interfering with the signals.</p>
                        <p>After cutting the battery leads, I connected the cables from the 650mAh battery to the JST connector as shown in the image below. </p>
                        <img src="assets/img/lab4_battery.png" style="object-fit:contain; width:100%">

                        <h2 class="section-heading">Record a Stunt</h2>
                        <iframe width="560" height="315" src="https://www.youtube.com/embed/55sHPNclHq0" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                    </div>
                </div>
            </div>
        </article>
        <!-- Footer-->
        <footer class="border-top">
            <div class="container px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5 justify-content-center">
                    <div class="col-md-10 col-lg-8 col-xl-7">
                        <ul class="list-inline text-center">
                            <li class="list-inline-item">
                                <a href="#!">
                                    <span class="fa-stack fa-lg">
                                        <i class="fas fa-circle fa-stack-2x"></i>
                                        <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li class="list-inline-item">
                                <a href="#!">
                                    <span class="fa-stack fa-lg">
                                        <i class="fas fa-circle fa-stack-2x"></i>
                                        <i class="fab fa-facebook-f fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li class="list-inline-item">
                                <a href="#!">
                                    <span class="fa-stack fa-lg">
                                        <i class="fas fa-circle fa-stack-2x"></i>
                                        <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                        </ul>
                        <div class="small text-center text-muted fst-italic">Copyright &copy; Your Website 2022</div>
                    </div>
                </div>
            </div>
        </footer>
        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="js/scripts.js"></script>
    </body>
</html>
